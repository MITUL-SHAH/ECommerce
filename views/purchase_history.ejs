<!DOCTYPE html>
<html>
<head>
    <meta charset="ISO-8859-1">
    <title>Purchase History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>

<body align="center">
<br> <br>
<h1 class="text-primary text-center mx-auto">Purchase History</h1>

<form action="#" method="post" name="login">

    <table class="table table-bordered">
        <thead>
        <tr class="table-primary">
            <th class="w-15 text-center">Item Id</th>
            <th class="w-15 text-center">Item Name</th>
            <th class="w-15 text-center">Purchase Date</th>
            <th class="w-15 text-center">Quantity (qty)</th>
            <th class="w-15 text-center">Cost</th>
            <th class="w-15 text-center">Actions</th>
        </tr>
        </thead>
        <tbody id="dynamicTable">
        <!-- Table rows will be added here -->
        </tbody>
    </table>


</form>
<br> <br>
<script>
            document.addEventListener('DOMContentLoaded', () => {
                const dynamicTable = document.getElementById('dynamicTable');

                let rowCounter = 0;

                // Populate table rows from an array
                var order_details = <%- JSON.stringify(order)  %>;
                for (const itemData of order_details) {
                rowCounter++;
                const newRow = document.createElement('tr');
                    if (itemData.return_status === 'not requested') {
                        content = `<button type="button" class="btn btn-danger btn-block" onclick="returnOrder(this)">Return Item</button>`;
                    } else if (itemData.return_status === 'Return Requested') {
                        content = `<div class="text-success">Return requested and in process</div><button type="button" class="btn btn-danger btn-block" onclick="cancelReturn(this)">Cancel Item Return</button>`;
                    }
                newRow.innerHTML = `
                    <td id="w-15 text-center">
                        <input type="hidden" for="item${rowCounter}" id="${itemData.listingId}" value="${itemData.listingId}">
                    </td>
                    <td class="w-15 text-center">
                        <label for="item${rowCounter}">${itemData.name}</label>
                    </td>
                    <td class="w-15 text-center">
                        <label for="item${rowCounter}">${itemData.purchase_date}</label>
                    </td>
                    <td class="w-15 text-center" >
                        <label for="item${rowCounter}">${itemData.quantity}</label>
                    </td>
                    <td class="w-15 text-center">
                        <label for="item${rowCounter}">${itemData.total_cost_of_item}</label>
                    </td>
                    <td class="w-15 text-center">
                        ${content}
                    </td>
                `;
                dynamicTable.appendChild(newRow);
            }
            });

            function returnOrder(button) {
                const listingId = button.parentElement.parentElement.children[0].children[0].value;

                // Use AJAX to send the POST request
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/users/return-order', true);
                xhr.setRequestHeader('Content-Type', 'application/json');

                // Define the data to be sent in the request body
                const data = JSON.stringify({ listingId: listingId });

                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        // Handle the response if needed
                        console.log(xhr.responseText);

                        // Refresh the page after a successful response
                        window.location.reload();
                    }
                };

                // Send the request
                xhr.send(data);

            }

            function cancelReturn(button) {
                const listingId = button.parentElement.parentElement.children[0].children[0].value;

                // Use AJAX to send the POST request
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/users/cancel-return', true);
                xhr.setRequestHeader('Content-Type', 'application/json');

                // Define the data to be sent in the request body
                const data = JSON.stringify({ listingId: listingId });

                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        // Handle the response if needed
                        console.log(xhr.responseText);

                        // Refresh the page after a successful response
                        window.location.reload();
                    }
                };

                // Send the request
                xhr.send(data);

            }
</script>

</body>
</html>
