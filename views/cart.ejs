<!DOCTYPE html>
<html>
<head>
    <meta charset="ISO-8859-1">
    <title>Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
    
<body align="center">
    <br> <br>
    <h1 class="text-primary text-center mx-auto">Cart</h1>

    <form action="#" method="post" name="login">

        <table class="table table-bordered">
            <thead>
                <tr class="table-primary">
                    <th class="w-25 text-center">Item Name</th>
                    <th class="w-25 text-center">Quantity (qty)</th>
                    <th class="w-25 text-center">Cost per item</th>
                    <th class="w-25 text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="dynamicTable">
                <!-- Table rows will be added here -->
            </tbody>
        </table>

        <div class="form-group" id = "promocode">
            <input type="text" class="form-control" name="promocode" id="promocode" placeholder="Enter Promo code if any?" onchange="checkpromocode(this.value)"><br>
        </div>

        <div id="hiddenElement" style="display: none;"></div>

        <br>

        <div class="form-group" id = "address">

            <input type="text" class="form-control" name="address1" id="address1" placeholder="Address line 1" required><br>

            <input type="text" class="form-control" name="address2" id="address2" placeholder="Address line 2"><br>

            <input type="text" class="form-control" name="address3" id="address3" placeholder="city" required><br>

            <input type="text" class="form-control" name="address4" id="address4" placeholder="state" required><br>

            <input type="text" class="form-control" name="address5" id="address5" placeholder="pincode" required><br>
        </div>
        
        <div class="col-md-3 text-center mx-auto">
            <button type="button" class="btn btn-danger align-self-center" id="removeAll">Flush Cart</button>
            <button type="submit" class="btn btn-primary align-self-center" id="getFinalCost">Get Final Cost</button>
        </div>
    </form>
    <br> <br>
    <script>
        var cartDetails;
        document.addEventListener('DOMContentLoaded', function() {
            event.preventDefault();
			fetch('/cart/fetch-cart')
			.then(response => response.json())
			.then(data => {
                console.log("data");
				if (data) {
					console.log(data.cartDetails);
				}
			})
		});

        document.getElementById('removeAll').addEventListener('click', () => {
            // Remove all rows from the table
            const dynamicTable = document.getElementById('dynamicTable');
            const address = document.getElementById('address');
            const promocode = document.getElementById('promocode');
            dynamicTable.innerHTML = '';
            address.innerHTML = '';
            promocode.innerHTML = '';

            //send ajax post request to flush
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/cart/flush", true);
            xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhttp.send();
        });

        function checkpromocode(promocode)
        {
            console.log(promocode);
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/cart/check-promo-code", true);
            xhttp.setRequestHeader("Content-type", "application/json");

            var data = JSON.stringify({ "promocode": promocode});
            
            xhttp.onreadystatechange = function () {
                var hiddenElement = document.getElementById("hiddenElement");
                
                if (xhttp.readyState == 4) {
                // Check if the request was successful (status code 200)
                    if (xhttp.status == 200) {
                        // Parse the response JSON if applicable
                        var jsonResponse = JSON.parse(xhttp.responseText);
                        var dynamicContent = "PROMOCODE found, Hurray!!!!";
                        hiddenElement.innerHTML = dynamicContent;
                        hiddenElement.style.display = "block";
                    } else {
                        // Handle the error or non-200 status code here
                        var dynamicContent = "PROMOCODE not found, Sorry!!!";
                        hiddenElement.innerHTML = dynamicContent;
                        hiddenElement.style.display = "block";
                    }
                }
            };

            xhttp.send(data);
        }
    </script>

</body>
</html>
